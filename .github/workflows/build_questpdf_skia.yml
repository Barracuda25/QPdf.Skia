name: Build Skia + QuestPDF

permissions: {}

on:
  workflow_dispatch:

jobs:
  main:
    name: ${{ matrix.runtime.name }}
    runs-on: ${{ matrix.runtime.runs-on }}
    container: ${{ matrix.runtime.container }}
    timeout-minutes: 40
      
    strategy:
      fail-fast: false
      max-parallel: 3
      matrix:
        runtime: 
        - name: win-x64
          runs-on: windows-latest
        - name: linux-x64
          runs-on: ubuntu-22.04          
        - name: linux-musl-x64
          runs-on: ubuntu-latest
          container: alpine:3.17
    env:
      ACTIONS_ALLOW_USE_UNSECURE_NODE_VERSION: true    
      DEBIAN_FRONTEND: noninteractive

    steps:
      - uses: actions/checkout@v4       

      - name: Install Build Tools
        if: matrix.runtime.name == 'linux-x64'
        shell: bash
        run: |
            sudo apt-get update -qq
            sudo apt-get upgrade -qq --yes
            sudo apt-get install -y wget git cmake fontconfig software-properties-common

          
      - name: Install Clang
        if: matrix.runtime.name == 'linux-x64' 
        shell: bash
        run: |
          sudo apt-get install -y clang-15 lldb-15 lld-15 libstdc++-12-dev
          sudo update-alternatives --install /usr/bin/cc cc /usr/bin/clang-15 100
          sudo update-alternatives --install /usr/bin/c++ c++ /usr/bin/clang++-15 100
          sudo update-alternatives --config cc
          sudo update-alternatives --config c++
          clang --version
          clang++ --version

          
      - name: Install Cmake
        if: matrix.runtime.name == 'linux-x64'
        shell: bash
        run: |
          sudo apt-get install -y cmake
          cmake --version
      
      - name: Install Python 3.10
        if: matrix.runtime.name == 'linux-x64' 
        shell: bash
        run: |
          sudo apt-get install -y build-essential zlib1g-dev libncurses5-dev libgdbm-dev \
                                  libnss3-dev libssl-dev libreadline-dev libffi-dev wget
          wget https://www.python.org/ftp/python/3.10.19/Python-3.10.19.tgz
          tar xzf Python-3.10.19.tgz
          cd Python-3.10.19
          ./configure --enable-optimizations
          make -j2 --silent
          sudo make install --silent
          python3 --version

            
      - name: Install Build Tools (Alpine)
        if: matrix.runtime.name == 'linux-musl-x64'
        shell: sh
        run: |
          apk update
          apk upgrade
          apk add bash wget git python3 build-base cmake clang llvm15 icu-libs linux-headers bsd-compat-headers gn fontconfig font-noto tar xz

          
      - name: Install 3.x
        if: runner.os != 'Linux'
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'


      - name: Install Skia Build System
        if: matrix.runtime.name != 'linux-musl-x64'
        shell: bash
        run: |
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
          echo "${PWD}/depot_tools" >> $GITHUB_PATH
          export PATH="${PWD}/depot_tools:${PATH}"

          
      - name: Build Skia
        shell: bash
        run: |
          git clone --depth 1 https://github.com/google/skia.git --branch chrome/m146 --single-branch
          cd skia
          git apply --ignore-whitespace ../patches/*.patch
          
          bin/fetch-ninja
          python3 tools/git-sync-deps
          COMMON_ARGS='
            is_official_build=true
            is_component_build=false
            is_debug=false
            skia_enable_optimize_size=true
            skia_enable_tools=true
            skia_use_system_expat=false
            skia_use_system_icu=false
            skia_use_system_harfbuzz=false
            skia_use_system_libjpeg_turbo=false
            skia_use_system_libpng=false
            skia_use_system_libwebp=false
            skia_use_system_zlib=false
            skia_use_system_freetype2=false
            skia_use_dng_sdk=false
            skia_use_harfbuzz=true
            skia_use_icu=false
            skia_use_icu4x=false
            skia_use_libgrapheme=true
            skia_use_fontconfig=false
            skia_use_gl=false
            skia_use_zlib=true
            skia_use_libjpeg_turbo_decode=true
            skia_use_libjpeg_turbo_encode=true
            skia_use_libpng_encode=true
            skia_use_libpng_decode=true
            skia_use_libwebp_encode=true
            skia_use_libwebp_decode=true
            skia_enable_android_utils=false
            skia_enable_spirv_validation=false
            skia_enable_gpu=false
            skia_enable_gpu_debug_layers=false
            skia_enable_fontmgr_custom_directory=true
            skia_use_freetype=true
            skia_use_jpeg_gainmaps=false
            skia_use_libheif=false
            skia_use_lua=false
            skia_enable_svg=true
            skia_use_expat=true
            skia_enable_skshaper=true
            skia_enable_skunicode=true
            skia_pdf_subset_harfbuzz=true
            skia_enable_pdf=true
            skia_compile_modules=false
            skia_enable_ganesh=false
            skia_lex=false
            extra_cflags=["-fPIC", "-fno-rtti"]'
            
          if [[ "${{ matrix.runtime.name }}" == linux-* ]]; then
            COMMON_ARGS+=' cc="clang" cxx="clang++"'
          fi
          
          if [ "${{ runner.os }}" = "macOS" ]; then
            COMMON_ARGS+=' skia_use_fonthost_mac=true'
          fi
                  
          if [ "${{ matrix.runtime.name }}" = "linux-musl-x64" ]; then
            gn gen out/release --args="$COMMON_ARGS"
          else
            bin/gn gen out/release --args="$COMMON_ARGS"
          fi
          
          ninja -C out/release skia svg skparagraph skresources
          
      - name: Prepare Skia artifacts
        shell: bash
        run: |
          mkdir -p output/skia/${{ matrix.runtime.name }}
          cp -r skia/out/release/* output/skia/${{ matrix.runtime.name }}/ 2>/dev/null || true
          echo "Skia build artifacts copied for ${{ matrix.runtime.name }}"
      
      - name: Upload Skia artifacts
        uses: actions/upload-artifact@v4
        with:
          name: skia-m146-${{ matrix.runtime.name }}
          path: output/skia
          retention-days: 30

  merge:
    runs-on: ubuntu-latest
    needs: main
    steps:
      - name: Merge native libraries
        uses: actions/upload-artifact/merge@v4
        with:
          name: questpdf-native-libraries
          pattern: questpdf-native-libraries-*
          delete-merged: true


      - name: Merge test results
        uses: actions/upload-artifact/merge@v4
        with:
          name: questpdf-test-results
          pattern: questpdf-test-results-*
          delete-merged: true
